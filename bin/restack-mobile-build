#!/usr/bin/env node

//remove dir and files
var program = require('./program');
var fs = require('fs');

const distDir = program.cwd+"/dist"
const happypackCache = program.cwd+"/.happypack"
var deleteFolderRecursive = function(path) {
  if( fs.existsSync(path) ) {
    fs.readdirSync(path).forEach(function(file,index){
      var curPath = path + "/" + file;
      if(fs.lstatSync(curPath).isDirectory()) { // recurse
        deleteFolderRecursive(curPath);
      } else { // delete file
        fs.unlinkSync(curPath);
      }
    });
    fs.rmdirSync(path);
  }
};

deleteFolderRecursive(distDir)
//if we don't delete it, the development cache will be used automatic
//and make the bundle unusable
deleteFolderRecursive(happypackCache)

//build production files
console.log("build with production enviroment")
var webpack = __dirname+"/../node_modules/webpack/bin/webpack"
var config = __dirname+"/../lib/webpack/webpack.prod.config.js"
var exec = require('child_process').exec;
var cmd = 'node '+webpack+' -p --progress --profile --config '+config;

exec(cmd,{'env':{'NODE_ENV':'production','BABEL_ENV':'server'}}, function(error, stdout, stderr) {
  // command output is in stdout
  console.log(stdout)
  console.error(stderr)
});
